service: datareal-repot
frameworkVersion: ^2.25

plugins:
  - serverless-prune-plugin

provider:
  name: aws
  runtime: go1.x
  lambdaHashingVersion: 20201221
  stage: dev
  environment:
    SLACK_WEBHOOK_REPORTS: ${env:SLACK_WEBHOOK_REPORTS}
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - dynamodb:Scan
          Resource:
            - ${self:custom.crawlerReportsTableArn}
        - Effect: Allow
          Action:
            - dynamodb:Query
          Resource:
            - ${self:custom.crawlerReportsTableArn}
            - Fn::Join:
              - "/"
              -
                - ${self:custom.crawlerReportsTableArn}
                - "index/*"
#  iamRoleStatements:
#    - Effect: "Allow"
#      Action:
#        - "s3:ListBucket"
#      Resource: { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "ServerlessDeploymentBucket" } ] ]  }
#    - Effect: "Allow"
#      Action:
#        - "s3:PutObject"
#      Resource:
#        Fn::Join:
#          - ""
#          - - "arn:aws:s3:::"
#            - "Ref" : "ServerlessDeploymentBucket"
#            - "/*"

package:
  exclude:
    - ./**
  include:
    - ./dist/**

functions:
  share:
    handler: dist/lambda/share
    events:
      - httpApi:
          path: /share
          method: post
  create:
    handler: dist/lambda/create
    events:
      - httpApi:
          path: /create
          method: post

custom:
  prune:
    automatic: true
    number: 3
  crawlerReportsTableName: "datareal-crawler-reports"
  crawlerReportsTableArn:
    Fn::Join:
    - ":"
    - - arn
      - aws
      - dynamodb
      - Ref: AWS::Region
      - Ref: AWS::AccountId
      - table/${self:custom.crawlerReportsTableName}